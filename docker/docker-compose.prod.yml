# Production docker-compose - pulls pre-built images from ghcr.io
# Used by GitHub Actions deploy workflow
version: '3.8'

services:
  singularity:
    image: ghcr.io/cypherpunk-agency/singularity:prod
    container_name: singularity-agent
    restart: unless-stopped

    env_file:
      - ../.env

    environment:
      - AGENT_MODEL=${AGENT_MODEL:-sonnet}
      - TZ=${TZ:-UTC}
      # Control Plane
      - CONTROL_PLANE_PORT=${CONTROL_PLANE_PORT:-3001}
      - CONTROL_PLANE_TOKEN=${CONTROL_PLANE_TOKEN:-}
      - APP_DIR=/app
      # Vector service (for memory search)
      - VECTOR_SERVICE_URL=${VECTOR_SERVICE_URL:-http://vector:5000}
      # OpenAI API (for Whisper transcription)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-openai}

    ports:
      # Control Plane API + WebSocket
      - "${CONTROL_PLANE_PORT:-3001}:3001"
      # Web UI (served by control plane in production)
      - "3000:3000"

    volumes:
      # Agent files (tasks, memory, conversation)
      - ../agent:/app/agent

      # Logs directory
      - ../logs:/app/logs

      # State persistence (session, vector DB, history)
      - ../state:/app/state

      # Claude CLI session data
      - claude-data:/home/agent/.claude

    tty: true
    stdin_open: true

    depends_on:
      vector:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  vector:
    image: ghcr.io/cypherpunk-agency/singularity-vector:prod
    container_name: singularity-vector
    restart: unless-stopped

    environment:
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - APP_DIR=/app
      - EXTRA_SCAN_DIRS=${EXTRA_SCAN_DIRS:-}

    volumes:
      # State persistence (vector DB)
      - ../state:/app/state

      # Agent files (read-only - for indexing memory)
      - ../agent:/app/agent:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  claude-data:
    name: singularity-claude-data
