version: '3.8'

services:
  singularity:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: singularity-agent
    restart: unless-stopped

    env_file:
      - ../.env

    environment:
      - AGENT_MODEL=${AGENT_MODEL:-sonnet}
      - TZ=${TZ:-UTC}
      # Control Plane
      - CONTROL_PLANE_PORT=${CONTROL_PLANE_PORT:-3001}
      - CONTROL_PLANE_TOKEN=${CONTROL_PLANE_TOKEN:-}
      - APP_DIR=/app
      # Vector service (for memory search)
      - VECTOR_SERVICE_URL=http://vector:5000
      # Transcription service (for voice messages)
      - TRANSCRIPTION_SERVICE_URL=http://transcription:5001
      # TTS service (for voice responses)
      - TTS_SERVICE_URL=http://tts:8880
      # OpenAI API (for Whisper transcription)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-auto}
      # Telegram (optional) - loaded from env_file

    ports:
      # Control Plane API + WebSocket
      - "${CONTROL_PLANE_PORT:-3001}:3001"
      # Web UI (served by control plane in production)
      - "3000:3000"

    volumes:
      # Agent files (tasks, memory, conversation)
      - ../agent:/app/agent

      # Logs directory
      - ../logs:/app/logs

      # State persistence (session, vector DB, history)
      - ../state:/app/state

      # Context files (SOUL.md, CONVERSATION.md, HEARTBEAT.md - now under agent/)
      - ../agent/context:/app/agent/context

      # Claude CLI session data
      - claude-data:/home/agent/.claude

      # Scripts (for development - can remove in production)
      - ../scripts:/app/scripts:ro

      # Packages source (for live editing)
      - ../packages:/app/packages
      # Keep node_modules inside container (pnpm symlinks don't work cross Windows/Linux)
      - /app/node_modules
      - /app/packages/shared/node_modules
      - /app/packages/control-plane/node_modules
      - /app/packages/ui/node_modules

    # Keep container running
    tty: true
    stdin_open: true

    depends_on:
      vector:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  vector:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vector
    container_name: singularity-vector
    restart: unless-stopped

    environment:
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - APP_DIR=/app
      - EXTRA_SCAN_DIRS=${EXTRA_SCAN_DIRS:-}

    volumes:
      # State persistence (vector DB)
      - ../state:/app/state

      # Agent files (read-only - for indexing memory)
      - ../agent:/app/agent:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  transcription:
    build:
      context: ..
      dockerfile: docker/Dockerfile.transcription
    container_name: singularity-transcription
    restart: unless-stopped

    environment:
      - WHISPER_MODEL=large-v3-turbo
      - WHISPER_DEVICE=cuda

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  tts:
    image: ghcr.io/remsky/kokoro-fastapi-gpu:latest
    container_name: singularity-tts
    restart: unless-stopped

    environment:
      - DEFAULT_VOICE=af_bella

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  claude-data:
    name: singularity-claude-data
